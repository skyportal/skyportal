"""Spatial catalog migration

Revision ID: e10fa2a9e71d
Revises: 2064509f3e08
Create Date: 2022-12-27 04:02:41.707729

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql
import healpix_alchemy

# revision identifiers, used by Alembic.
revision = 'e10fa2a9e71d'
down_revision = '2064509f3e08'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        'spatial_catalogs',
        sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('modified', sa.DateTime(), nullable=False),
        sa.Column('catalog_name', sa.String(), nullable=False),
        sa.PrimaryKeyConstraint('id'),
    )
    op.create_index(
        op.f('ix_spatial_catalogs_catalog_name'),
        'spatial_catalogs',
        ['catalog_name'],
        unique=True,
    )
    op.create_index(
        op.f('ix_spatial_catalogs_created_at'),
        'spatial_catalogs',
        ['created_at'],
        unique=False,
    )
    op.create_table(
        'spatial_catalog_entries',
        sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('modified', sa.DateTime(), nullable=False),
        sa.Column('catalog_id', sa.Integer(), nullable=False),
        sa.Column('entry_name', sa.String(), nullable=False),
        sa.Column('data', postgresql.JSONB(astext_type=sa.Text()), nullable=False),
        sa.Column('uniq', sa.ARRAY(sa.BigInteger()), nullable=False),
        sa.Column('probdensity', sa.ARRAY(sa.Float()), nullable=False),
        sa.ForeignKeyConstraint(
            ['catalog_id'], ['spatial_catalogs.id'], ondelete='CASCADE'
        ),
        sa.PrimaryKeyConstraint('id', 'catalog_id'),
    )
    op.create_index(
        op.f('ix_spatial_catalog_entries_catalog_id'),
        'spatial_catalog_entries',
        ['catalog_id'],
        unique=False,
    )
    op.create_index(
        op.f('ix_spatial_catalog_entries_created_at'),
        'spatial_catalog_entries',
        ['created_at'],
        unique=False,
    )
    op.create_index(
        op.f('ix_spatial_catalog_entries_data'),
        'spatial_catalog_entries',
        ['data'],
        unique=False,
    )
    op.create_index(
        op.f('ix_spatial_catalog_entries_entry_name'),
        'spatial_catalog_entries',
        ['entry_name'],
        unique=True,
    )
    op.create_table(
        'spatial_catalog_entriess',
        sa.Column('id', sa.Integer(), autoincrement=True, nullable=False),
        sa.Column('created_at', sa.DateTime(), nullable=False),
        sa.Column('modified', sa.DateTime(), nullable=False),
        sa.Column('entry_name', sa.String(), nullable=False),
        sa.Column('probdensity', sa.Float(), nullable=False),
        sa.Column('healpix', healpix_alchemy.types.Tile(), nullable=False),
        sa.ForeignKeyConstraint(
            ['entry_name'], ['spatial_catalog_entries.entry_name'], ondelete='CASCADE'
        ),
        sa.PrimaryKeyConstraint('id', 'healpix'),
    )
    op.create_index(
        op.f('ix_spatial_catalog_entriess_created_at'),
        'spatial_catalog_entriess',
        ['created_at'],
        unique=False,
    )
    op.create_index(
        op.f('ix_spatial_catalog_entriess_healpix'),
        'spatial_catalog_entriess',
        ['healpix'],
        unique=False,
        postgresql_using='spgist',
    )
    op.create_index(
        op.f('ix_spatial_catalog_entriess_probdensity'),
        'spatial_catalog_entriess',
        ['probdensity'],
        unique=False,
    )
    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(
        op.f('ix_spatial_catalog_entriess_probdensity'),
        table_name='spatial_catalog_entriess',
    )
    op.drop_index(
        op.f('ix_spatial_catalog_entriess_healpix'),
        table_name='spatial_catalog_entriess',
        postgresql_using='spgist',
    )
    op.drop_index(
        op.f('ix_spatial_catalog_entriess_created_at'),
        table_name='spatial_catalog_entriess',
    )
    op.drop_table('spatial_catalog_entriess')
    op.drop_index(
        op.f('ix_spatial_catalog_entries_entry_name'),
        table_name='spatial_catalog_entries',
    )
    op.drop_index(
        op.f('ix_spatial_catalog_entries_data'), table_name='spatial_catalog_entries'
    )
    op.drop_index(
        op.f('ix_spatial_catalog_entries_created_at'),
        table_name='spatial_catalog_entries',
    )
    op.drop_index(
        op.f('ix_spatial_catalog_entries_catalog_id'),
        table_name='spatial_catalog_entries',
    )
    op.drop_table('spatial_catalog_entries')
    op.drop_index(op.f('ix_spatial_catalogs_created_at'), table_name='spatial_catalogs')
    op.drop_index(
        op.f('ix_spatial_catalogs_catalog_name'), table_name='spatial_catalogs'
    )
    op.drop_table('spatial_catalogs')
    # ### end Alembic commands ###
